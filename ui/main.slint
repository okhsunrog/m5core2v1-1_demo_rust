component StatusRow inherits HorizontalLayout {
    in property <string> label;
    in property <string> value;
    in property <color> value-color: white;
    spacing: 8px;
    Text { text: label; color: #aaaaaa; font-size: 13px; width: 80px; }
    Text { text: value; color: value-color; font-size: 13px; }
}

component CompactRow inherits HorizontalLayout {
    in property <string> label;
    in property <string> value;
    in property <color> value-color: white;
    spacing: 4px;
    Text { text: label; color: #aaaaaa; font-size: 11px; width: 50px; }
    Text { text: value; color: value-color; font-size: 11px; }
}

component TabButton inherits Rectangle {
    in property <string> label;
    in property <bool> active;
    callback clicked;

    background: active ? #334466 : #1a1a2e;
    border-radius: 4px;
    horizontal-stretch: 1;
    height: 28px;

    ta := TouchArea {
        clicked => { root.clicked(); }
    }

    Text {
        text: label;
        color: active ? #00d4ff : #666688;
        font-size: 12px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }
}

export component MainWindow inherits Window {
    in property <string> battery-percent: "?";
    in property <string> battery-voltage: "?";
    in property <string> vbus-voltage: "?";
    in property <string> vsys-voltage: "?";
    in property <string> temperature: "?";
    in property <string> touch-info: "none";
    in property <string> fps-text: "?";
    in property <string> clock-text: "?";
    in-out property <int> active-tab: 0;
    in-out property <int> tap-count: 0;
    in-out property <float> backlight-value: 0.5;
    in-out property <bool> ext5v-enabled: false;

    // USB PD properties
    in property <string> pd-status: "No chip";
    in property <string> pd-pdo1: "";
    in property <string> pd-pdo2: "";
    in property <string> pd-pdo3: "";
    in property <string> pd-pdo4: "";
    in property <string> pd-pdo5: "";
    in property <string> pd-pdo6: "";
    in property <string> pd-pdo7: "";

    // INA3221 properties
    in property <string> ina-ch1-voltage: "?";
    in property <string> ina-ch1-current: "?";
    in property <string> ina-ch2-voltage: "?";
    in property <string> ina-ch2-current: "?";
    in property <string> ina-ch3-voltage: "?";
    in property <string> ina-ch3-current: "?";

    // System info properties
    in property <string> cpu-freq: "?";
    in property <string> psram-size: "?";
    in property <string> free-sram: "?";
    in property <string> free-psram: "?";
    in property <string> uptime: "?";
    in property <string> chip-id: "?";
    in property <string> spi-freq: "?";
    in property <string> i2c-freq: "?";
    in property <string> display-res: "?";
    in property <string> render-time: "?";
    in property <string> frame-time: "?";
    in property <string> touch-chip: "?";
    in property <string> pmic-chip: "?";
    in property <string> dma-buf-size: "?";

    background: #1a1a2e;

    VerticalLayout {
        padding: 8px;
        spacing: 4px;

        // Header with clock and FPS
        HorizontalLayout {
            Text {
                text: "M5Stack Core2 v1.1";
                color: #00d4ff;
                font-size: 15px;
                horizontal-stretch: 1;
            }
            Text {
                text: clock-text;
                color: clock-text == "?" ? #666666 : #ffffff;
                font-size: 13px;
                vertical-alignment: center;
            }
            Text {
                text: " " + fps-text + " FPS";
                color: fps-text == "?" ? #666666 : #44ff44;
                font-size: 13px;
                vertical-alignment: center;
            }
        }

        Rectangle { height: 1px; background: #333366; }

        // Tab bar
        HorizontalLayout {
            spacing: 3px;
            TabButton {
                label: "Status";
                active: active-tab == 0;
                clicked => { root.active-tab = 0; }
            }
            TabButton {
                label: "Controls";
                active: active-tab == 1;
                clicked => { root.active-tab = 1; }
            }
            TabButton {
                label: "USB PD";
                active: active-tab == 2;
                clicked => { root.active-tab = 2; }
            }
            TabButton {
                label: "System";
                active: active-tab == 3;
                clicked => { root.active-tab = 3; }
            }
        }

        Rectangle { height: 1px; background: #333366; }

        // === Tab 0: Status (two columns) ===
        if active-tab == 0: HorizontalLayout {
            spacing: 8px;
            vertical-stretch: 1;

            // Left column — PMIC
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 3px;
                Text { text: "PMIC"; color: #00d4ff; font-size: 12px; }
                CompactRow { label: "Bat:"; value: root.battery-percent + "%"; value-color: #00ff88; }
                CompactRow { label: "Bat mV:"; value: root.battery-voltage; }
                CompactRow { label: "VBUS:"; value: root.vbus-voltage; }
                CompactRow { label: "VSYS:"; value: root.vsys-voltage; }
                CompactRow { label: "Temp:"; value: root.temperature + " C"; }
                Rectangle { height: 1px; background: #222244; }
                CompactRow { label: "Touch:"; value: root.touch-info; value-color: #44ff44; }
                Rectangle { vertical-stretch: 1; }
            }

            Rectangle { width: 1px; background: #333366; }

            // Right column — INA3221
            VerticalLayout {
                horizontal-stretch: 1;
                spacing: 3px;
                Text { text: "INA3221"; color: #00d4ff; font-size: 12px; }
                CompactRow { label: "Bat V:"; value: root.ina-ch1-voltage; }
                CompactRow { label: "Bat I:"; value: root.ina-ch1-current; value-color: #ffaa44; }
                CompactRow { label: "Bus V:"; value: root.ina-ch2-voltage; }
                CompactRow { label: "Bus I:"; value: root.ina-ch2-current; value-color: #ffaa44; }
                CompactRow { label: "AXP V:"; value: root.ina-ch3-voltage; }
                CompactRow { label: "AXP I:"; value: root.ina-ch3-current; value-color: #ffaa44; }
                Rectangle { vertical-stretch: 1; }
            }
        }

        // === Tab 1: Controls ===
        if active-tab == 1: VerticalLayout {
            spacing: 8px;
            vertical-stretch: 1;

            // Backlight slider
            Text { text: "Backlight"; color: #aaaaaa; font-size: 13px; }

            Rectangle {
                height: 30px;
                background: #222244;
                border-radius: 6px;

                slider-area := TouchArea {
                    moved => {
                        root.backlight-value = Math.clamp(self.mouse-x / self.width, 0.0, 1.0);
                    }
                    clicked => {
                        root.backlight-value = Math.clamp(self.mouse-x / self.width, 0.0, 1.0);
                    }
                }

                // Track fill
                Rectangle {
                    x: 0;
                    y: (parent.height - self.height) / 2;
                    width: parent.width * root.backlight-value;
                    height: 8px;
                    background: #00d4ff;
                    border-radius: 4px;
                }

                // Thumb
                Rectangle {
                    x: (parent.width - self.width) * root.backlight-value;
                    y: (parent.height - self.height) / 2;
                    width: 20px;
                    height: 20px;
                    border-radius: 10px;
                    background: slider-area.pressed ? #ffffff : #cccccc;
                }
            }

            Text {
                text: Math.round(root.backlight-value * 100) + "%";
                color: white;
                font-size: 13px;
                horizontal-alignment: center;
            }

            Rectangle { height: 1px; background: #222244; }

            // Tap counter
            Text { text: "Tap Counter: " + root.tap-count; color: #aaaaaa; font-size: 13px; }

            HorizontalLayout {
                spacing: 8px;

                tap-btn := TouchArea {
                    horizontal-stretch: 1;
                    clicked => { root.tap-count += 1; }
                    Rectangle {
                        background: tap-btn.pressed ? #445566 : #2a2a4e;
                        border-radius: 8px;
                        border-width: 1px;
                        border-color: #444488;
                        height: 40px;
                        Text {
                            text: "Tap!";
                            color: tap-btn.pressed ? #00ff88 : #888888;
                            font-size: 15px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }

            Rectangle { vertical-stretch: 1; }
        }

        // === Tab 2: USB PD ===
        if active-tab == 2: VerticalLayout {
            spacing: 4px;
            vertical-stretch: 1;

            Text { text: "USB PD Source Capabilities"; color: #00d4ff; font-size: 13px; }
            Rectangle { height: 1px; background: #222244; }

            StatusRow { label: "Status:"; value: root.pd-status; value-color: root.pd-status == "Connected" ? #00ff88 : #ffaa44; }

            Rectangle { height: 4px; }

            if root.pd-pdo1 != "": CompactRow { label: "PDO 1:"; value: root.pd-pdo1; value-color: #00d4ff; }
            if root.pd-pdo2 != "": CompactRow { label: "PDO 2:"; value: root.pd-pdo2; value-color: #00d4ff; }
            if root.pd-pdo3 != "": CompactRow { label: "PDO 3:"; value: root.pd-pdo3; value-color: #00d4ff; }
            if root.pd-pdo4 != "": CompactRow { label: "PDO 4:"; value: root.pd-pdo4; value-color: #00d4ff; }
            if root.pd-pdo5 != "": CompactRow { label: "PDO 5:"; value: root.pd-pdo5; value-color: #00d4ff; }
            if root.pd-pdo6 != "": CompactRow { label: "PDO 6:"; value: root.pd-pdo6; value-color: #00d4ff; }
            if root.pd-pdo7 != "": CompactRow { label: "PDO 7:"; value: root.pd-pdo7; value-color: #00d4ff; }

            Rectangle { vertical-stretch: 1; }
        }

        // === Tab 3: System Info (scrollable) ===
        if active-tab == 3: Flickable {
            vertical-stretch: 1;

            VerticalLayout {
                spacing: 4px;
                padding-top: 4px;
                padding-bottom: 8px;

                Text { text: "Hardware"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                StatusRow { label: "CPU:"; value: root.cpu-freq; }
                StatusRow { label: "PSRAM:"; value: root.psram-size; }
                StatusRow { label: "SRAM free:"; value: root.free-sram; }
                StatusRow { label: "PSRAM free:"; value: root.free-psram; }
                StatusRow { label: "PMIC:"; value: root.pmic-chip; }
                StatusRow { label: "Touch IC:"; value: root.touch-chip; }
                StatusRow { label: "RTC:"; value: "BM8563"; }

                Rectangle { height: 8px; }
                Text { text: "Display"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                StatusRow { label: "Resolution:"; value: root.display-res; }
                StatusRow { label: "SPI freq:"; value: root.spi-freq; }
                StatusRow { label: "DMA buf:"; value: root.dma-buf-size; }

                Rectangle { height: 8px; }
                Text { text: "Performance"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                StatusRow { label: "Frame:"; value: root.frame-time; value-color: #44ff44; }
                StatusRow { label: "Render:"; value: root.render-time; value-color: #44ff44; }
                StatusRow { label: "FPS:"; value: root.fps-text; value-color: #44ff44; }

                Rectangle { height: 8px; }
                Text { text: "Communication"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                StatusRow { label: "I2C freq:"; value: root.i2c-freq; }
                StatusRow { label: "Chip ID:"; value: root.chip-id; }

                Rectangle { height: 8px; }
                Text { text: "Runtime"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                StatusRow { label: "Uptime:"; value: root.uptime; }

                Rectangle { height: 8px; }
                Text { text: "Controls"; color: #00d4ff; font-size: 14px; }
                Rectangle { height: 1px; background: #222244; }

                HorizontalLayout {
                    spacing: 8px;
                    alignment: start;
                    Text { text: "Ext 5V out:"; color: #aaaaaa; font-size: 13px; width: 80px; vertical-alignment: center; }
                    ext5v-toggle := TouchArea {
                        width: 44px;
                        height: 24px;
                        clicked => { root.ext5v-enabled = !root.ext5v-enabled; }
                        Rectangle {
                            background: root.ext5v-enabled ? #00d4ff : #333355;
                            border-radius: 12px;
                            animate background { duration: 150ms; }
                            Rectangle {
                                x: root.ext5v-enabled ? parent.width - self.width - 2px : 2px;
                                y: 2px;
                                width: 20px;
                                height: 20px;
                                border-radius: 10px;
                                background: white;
                                animate x { duration: 150ms; }
                            }
                        }
                    }
                    Text {
                        text: root.ext5v-enabled ? "ON" : "OFF";
                        color: root.ext5v-enabled ? #00ff88 : #666666;
                        font-size: 13px;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}
